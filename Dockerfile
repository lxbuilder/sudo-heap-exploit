FROM lxbuilder/ubuntu-vnc-wine:1 as sudoBase

FROM lxbuilder/minimal as fakeEditor

FROM ubuntu:focal-20210119 as exploit

ARG DEBIAN_FRONTEND=noninteractive

RUN set -x && apt-get update && apt-get install -y gcc make wget unzip && rm -rf /var/lib/apt/lists/* && \
    wget https://github.com/r4j0x00/exploits/archive/ef6df68c08fa47182496d33e68e646a01549dec2.zip && \
    unzip ef6df68c08fa47182496d33e68e646a01549dec2.zip && \
    rm -f ef6df68c08fa47182496d33e68e646a01549dec2.zip && \
    mv /exploits-ef6df68c08fa47182496d33e68e646a01549dec2/CVE-2021-3156/exploit /exploits-ef6df68c08fa47182496d33e68e646a01549dec2/CVE-2021-3156/old-exploit  && \
    gcc /exploits-ef6df68c08fa47182496d33e68e646a01549dec2/CVE-2021-3156/exploit.c -o /exploits-ef6df68c08fa47182496d33e68e646a01549dec2/CVE-2021-3156/exploit && \
    cd /exploits-ef6df68c08fa47182496d33e68e646a01549dec2/CVE-2021-3156_one_shot && \
    make

FROM ubuntu:focal-20210119 as intermediate

ARG DEBIAN_FRONTEND=noninteractive

COPY --from=sudoBase /etc/pam.d/sudo /etc/pam.d/sudo
COPY --from=sudoBase /etc/sudoers /etc/sudoers
COPY --from=sudoBase /usr/bin/cvtsudoers /usr/bin/cvtsudoers
COPY --from=sudoBase /usr/bin/sudo /usr/bin/sudo
COPY --from=sudoBase /usr/bin/sudoreplay /usr/bin/sudoreplay
COPY --from=sudoBase /usr/include/sudo_plugin.h /usr/include/sudo_plugin.h 
COPY --from=sudoBase /usr/lib/sudo /usr/lib/sudo
COPY --from=sudoBase /usr/lib/tmpfiles.d/sudo.conf /usr/lib/tmpfiles.d/sudo.conf
COPY --from=sudoBase /usr/sbin/visudo /usr/sbin/visudo

COPY --from=fakeEditor /true /usr/bin/editor

RUN set -x && ln -s /usr/bin/sudo /usr/bin/sudoedit && \
    adduser --disabled-password --gecos "" user

COPY --from=exploit /exploits-ef6df68c08fa47182496d33e68e646a01549dec2 /home/user/exploits

RUN set -x && chown -R user:user /home/user/

FROM scratch

COPY --from=intermediate / /

USER user

WORKDIR /home/user/exploits

CMD [ "/bin/bash" ]
